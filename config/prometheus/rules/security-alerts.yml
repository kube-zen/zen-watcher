apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: zen-watcher-security-events
  namespace: zen-system
  labels:
    app.kubernetes.io/name: zen-watcher
    app.kubernetes.io/component: security-alerts
    prometheus: kube-prometheus-stack
    role: alert-rules
spec:
  groups:
  # Critical Security Events - Immediate Response Required
  - name: zen-watcher.critical-security
    interval: 30s
    rules:
    # Falco Critical Runtime Threats
    - alert: FalcoCriticalRuntimeThreat
      expr: sum(rate(zen_watcher_events_total{source="falco",severity="critical"}[2m])) by (namespace, kind) * 60 > 1
      for: 0s
      labels:
        severity: critical
        component: runtime-security
        source: falco
        category: threat-detection
        runbook_category: runtime_incident
      annotations:
        summary: "Critical runtime security threat detected by Falco"
        description: "Falco detected {{$value}} critical security events/min. Namespace: {{$labels.namespace}}, Kind: {{$labels.kind}}"
        runbook_url: "https://github.com/kube-zen/zen-watcher/blob/main/docs/SECURITY_INCIDENT_RESPONSE.md#falco-runtime-threats"
        escalation_policy: "critical-immediate"
        action_required: "Investigate Falco events in namespace {{$labels.namespace}}"
        
    # Critical Vulnerability Detected
    - alert: CriticalVulnerabilityDetected
      expr: sum(rate(zen_watcher_events_total{source="trivy",severity="critical"}[5m])) by (eventType, kind, namespace) * 60 > 0
      for: 0s
      labels:
        severity: critical
        component: vulnerability-management
        source: trivy
        category: vulnerability
        runbook_category: vuln_response
      annotations:
        summary: "Critical vulnerability detected"
        description: "Trivy found {{$value}} critical vulnerabilities/min. EventType: {{$labels.eventType}}, Resource: {{$labels.kind}}/{{$labels.namespace}}"
        runbook_url: "https://github.com/kube-zen/zen-watcher/blob/main/docs/SECURITY_INCIDENT_RESPONSE.md#critical-vulnerabilities"
        escalation_policy: "critical-4h"
        action_required: "Patch or mitigate critical vulnerabilities in {{$labels.kind}} resources"
        
    # CIS Benchmark Critical Failure
    - alert: CISBenchmarkCriticalFailure
      expr: sum(rate(zen_watcher_events_total{source="kube-bench",category="compliance",severity=~"critical|high"}[5m])) * 60 > 0
      for: 0s
      labels:
        severity: critical
        component: compliance
        source: kube-bench
        category: compliance-failure
        runbook_category: compliance_incident
      annotations:
        summary: "Critical CIS benchmark compliance failure"
        description: "Kube-Bench detected {{$value}} critical/high compliance failures/min. EventType: {{$labels.eventType}}"
        runbook_url: "https://github.com/kube-zen/zen-watcher/blob/main/docs/SECURITY_INCIDENT_RESPONSE.md#cis-benchmark-failures"
        escalation_policy: "critical-24h"
        action_required: "Fix CIS benchmark compliance issues"
        
    # Critical Infrastructure as Code Issue
    - alert: CriticalIaCIssue
      expr: sum(rate(zen_watcher_events_total{source="checkov",severity="critical"}[5m])) by (eventType) * 60 > 0
      for: 0s
      labels:
        severity: critical
        component: infrastructure-security
        source: checkov
        category: iac-vulnerability
        runbook_category: iac_response
      annotations:
        summary: "Critical Infrastructure as Code security issue"
        description: "Checkov found {{$value}} critical IaC issues/min. EventType: {{$labels.eventType}}"
        runbook_url: "https://github.com/kube-zen/zen-watcher/blob/main/docs/SECURITY_INCIDENT_RESPONSE.md#iac-critical-issues"
        escalation_policy: "critical-24h"
        action_required: "Fix IaC security issues"
        
    # Suspicious Audit Activity
    - alert: SuspiciousAuditActivity
      expr: sum(rate(zen_watcher_events_total{source="audit",severity=~"critical|high"}[1m])) by (namespace, eventType) * 60 > 100
      for: 2m
      labels:
        severity: critical
        component: audit-logging
        source: audit
        category: suspicious-activity
        runbook_category: audit_incident
      annotations:
        summary: "Suspicious audit activity detected"
        description: "Unusual audit activity: {{$value}} critical/high events/min. Namespace: {{$labels.namespace}}, EventType: {{$labels.eventType}}"
        runbook_url: "https://github.com/kube-zen/zen-watcher/blob/main/docs/SECURITY_INCIDENT_RESPONSE.md#suspicious-audit-activity"
        escalation_policy: "critical-immediate"
        action_required: "Investigate suspicious activity in namespace {{$labels.namespace}}"
        
    # Policy Violation Critical
    - alert: PolicyViolationCritical
      expr: sum(rate(zen_watcher_events_total{source="kyverno",severity="critical"}[2m])) * 60 > 0
      for: 0s
      labels:
        severity: critical
        component: policy-enforcement
        source: kyverno
        category: policy-violation
        runbook_category: policy_incident
      annotations:
        summary: "Critical policy violation detected"
        description: "Kyverno policy violation detected. EventType: {{$labels.eventType}}, Resource: {{$labels.kind}}/{{$labels.namespace}}"
        runbook_url: "https://github.com/kube-zen/zen-watcher/blob/main/docs/SECURITY_INCIDENT_RESPONSE.md#policy-violations"
        escalation_policy: "critical-immediate"
        action_required: "Review and remediate policy violations"
        
    # Security Tool Outage - Multiple Tools
    - alert: MultipleSecurityToolsOffline
      expr: count(sum(zen_watcher_tools_active) by (tool) == 0) >= 3
      for: 5m
      labels:
        severity: critical
        component: security-infrastructure
        source: zen-watcher
        category: tool-availability
        runbook_category: infrastructure_incident
      annotations:
        summary: "Multiple security tools are offline"
        description: "{{$value}} security tools are offline for more than 5 minutes"
        runbook_url: "https://github.com/kube-zen/zen-watcher/blob/main/docs/SECURITY_INCIDENT_RESPONSE.md#security-tool-outages"
        escalation_policy: "critical-immediate"
        action_required: "Restore security tool functionality - check deployments and health"

  # High Priority Security Events - Same Day Response
  - name: zen-watcher.high-security
    interval: 30s
    rules:
    # High Severity Vulnerability
    - alert: HighSeverityVulnerability
      expr: sum(rate(zen_watcher_events_total{source="trivy",severity="high"}[5m])) * 60 > 5
      for: 5m
      labels:
        severity: warning
        component: vulnerability-management
        source: trivy
        category: vulnerability
        runbook_category: vuln_response
      annotations:
        summary: "High severity vulnerability detected"
        description: "Trivy found {{$value}} high severity vulnerabilities/min. EventType: {{$labels.eventType}}"
        runbook_url: "https://github.com/kube-zen/zen-watcher/blob/main/docs/SECURITY_INCIDENT_RESPONSE.md#high-vulnerabilities"
        escalation_policy: "high-24h"
        action_required: "Plan response for high severity vulnerabilities"
        
    # Falco High Priority Events
    - alert: FalcoHighPriorityEvent
      expr: sum(rate(zen_watcher_events_total{source="falco",severity="high"}[2m])) by (eventType) * 60 > 10
      for: 5m
      labels:
        severity: warning
        component: runtime-security
        source: falco
        category: threat-detection
        runbook_category: runtime_incident
      annotations:
        summary: "High priority runtime security event"
        description: "Falco detected {{$value}} high severity events/min. EventType: {{$labels.eventType}}"
        runbook_url: "https://github.com/kube-zen/zen-watcher/blob/main/docs/SECURITY_INCIDENT_RESPONSE.md#falco-warning-events"
        escalation_policy: "high-4h"
        action_required: "Review Falco events for potential security concerns"
        
    # Compliance Warning
    - alert: CISBenchmarkWarning
      expr: sum(rate(zen_watcher_events_total{source="kube-bench",severity="medium"}[5m])) * 60 > 2
      for: 10m
      labels:
        severity: warning
        component: compliance
        source: kube-bench
        category: compliance-warning
        runbook_category: compliance_incident
      annotations:
        summary: "CIS benchmark compliance warning"
        description: "Kube-Bench detected {{$value}} medium severity compliance warnings/min"
        runbook_url: "https://github.com/kube-zen/zen-watcher/blob/main/docs/SECURITY_INCIDENT_RESPONSE.md#cis-benchmark-warnings"
        escalation_policy: "high-48h"
        action_required: "Review and address compliance warnings"
        
    # High Severity IaC Issue
    - alert: HighSeverityIaCIssue
      expr: sum(rate(zen_watcher_events_total{source="checkov",severity="high"}[5m])) by (eventType) * 60 > 3
      for: 10m
      labels:
        severity: warning
        component: infrastructure-security
        source: checkov
        category: iac-vulnerability
        runbook_category: iac_response
      annotations:
        summary: "High severity Infrastructure as Code issue"
        description: "Checkov found {{$value}} high severity IaC issues/min. EventType: {{$labels.eventType}}"
        runbook_url: "https://github.com/kube-zen/zen-watcher/blob/main/docs/SECURITY_INCIDENT_RESPONSE.md#iac-high-issues"
        escalation_policy: "high-48h"
        action_required: "Review and fix IaC security issues"
        
    # Unauthorized Access Attempt
    - alert: UnauthorizedAccessAttempt
      expr: sum(rate(zen_watcher_events_total{source="audit",eventType=~".*unauthorized.*|.*forbidden.*",severity=~"critical|high"}[2m])) by (namespace) * 60 > 50
      for: 5m
      labels:
        severity: warning
        component: audit-logging
        source: audit
        category: unauthorized-access
        runbook_category: access_incident
      annotations:
        summary: "Potential unauthorized access attempt"
        description: "High rate of unauthorized/forbidden operations: {{$value}} operations/min. Namespace: {{$labels.namespace}}"
        runbook_url: "https://github.com/kube-zen/zen-watcher/blob/main/docs/SECURITY_INCIDENT_RESPONSE.md#unauthorized-access"
        escalation_policy: "high-2h"
        action_required: "Review access patterns - potential unauthorized activity"
        
    # Policy Violation Warning
    - alert: PolicyViolationWarning
      expr: sum(rate(zen_watcher_events_total{source="kyverno",severity="high"}[2m])) by (eventType, namespace) * 60 > 5
      for: 5m
      labels:
        severity: warning
        component: policy-enforcement
        source: kyverno
        category: policy-violation
        runbook_category: policy_incident
      annotations:
        summary: "Policy violation warning"
        description: "Kyverno policy violation warning. EventType: {{$labels.eventType}}, Namespace: {{$labels.namespace}}"
        runbook_url: "https://github.com/kube-zen/zen-watcher/blob/main/docs/SECURITY_INCIDENT_RESPONSE.md#policy-warnings"
        escalation_policy: "high-8h"
        action_required: "Review policy configuration"

  # Medium Priority Security Events - Within Week Response
  - name: zen-watcher.medium-security
    interval: 1m
    rules:
    # Medium Severity Vulnerabilities
    - alert: MediumSeverityVulnerability
      expr: sum(rate(zen_watcher_events_total{source="trivy",severity="medium"}[5m])) * 60 > 20
      for: 15m
      labels:
        severity: info
        component: vulnerability-management
        source: trivy
        category: vulnerability
        runbook_category: vuln_response
      annotations:
        summary: "Medium severity vulnerability trend"
        description: "Trivy found {{$value}} medium severity vulnerabilities/min. EventType: {{$labels.eventType}}"
        runbook_url: "https://github.com/kube-zen/zen-watcher/blob/main/docs/SECURITY_INCIDENT_RESPONSE.md#medium-vulnerabilities"
        escalation_policy: "medium-1w"
        action_required: "Plan response for multiple medium severity vulnerabilities"
        
    # Security Tool Single Outage
    - alert: SecurityToolOffline
      expr: sum(zen_watcher_tools_active) by (tool) == 0
      for: 10m
      labels:
        severity: info
        component: security-infrastructure
        source: zen-watcher
        category: tool-availability
        runbook_category: infrastructure_incident
      annotations:
        summary: "Security tool {{$labels.tool}} is offline"
        description: "Tool {{$labels.tool}} has been offline for more than 10 minutes"
        runbook_url: "https://github.com/kube-zen/zen-watcher/blob/main/docs/SECURITY_INCIDENT_RESPONSE.md#single-tool-offline"
        escalation_policy: "medium-4h"
        action_required: "Check status and restore {{$labels.tool}} service"
        
    # Normal Audit Activity Spike
    - alert: AuditActivitySpike
      expr: sum(rate(zen_watcher_events_total{source="audit"}[5m])) * 60 > 1000
      for: 10m
      labels:
        severity: info
        component: audit-logging
        source: audit
        category: activity-spike
        runbook_category: monitoring
      annotations:
        summary: "Unusual audit activity volume"
        description: "Audit event rate is {{$value}} events/min - higher than normal baseline"
        runbook_url: "https://github.com/kube-zen/zen-watcher/blob/main/docs/SECURITY_INCIDENT_RESPONSE.md#audit-spikes"
        escalation_policy: "medium-2h"
        action_required: "Review audit log volume increase - investigate if legitimate"

  # Anomaly Detection and Behavioral Analysis
  - name: zen-watcher.security-anomalies
    interval: 2m
    rules:
    # Security Event Anomaly Detection
    - alert: SecurityEventAnomaly
      expr: |
        (
          sum(rate(zen_watcher_events_total{severity=~"critical|high"}[5m])) * 60
        ) > (
          avg_over_time(sum(rate(zen_watcher_events_total{severity=~"critical|high"}[5m]))[1h:5m]) * 60 * 3
        )
      for: 3m
      labels:
        severity: warning
        component: anomaly-detection
        source: zen-watcher
        category: behavioral-anomaly
        runbook_category: anomaly_investigation
      annotations:
        summary: "Anomalous security event pattern detected"
        description: "Security event rate is 3x higher than baseline. Current: {{$value}} events/min"
        runbook_url: "https://github.com/kube-zen/zen-watcher/blob/main/docs/SECURITY_INCIDENT_RESPONSE.md#security-anomalies"
        escalation_policy: "high-1h"
        action_required: "Investigate unusual security event pattern - possible security incident"
        
    # Namespace Behavioral Anomaly
    - alert: NamespaceBehavioralAnomaly
      expr: |
        (
          sum(rate(zen_watcher_events_total{source="audit"}[5m]) by (namespace)) * 60
        ) > (
          avg_over_time(sum(rate(zen_watcher_events_total{source="audit"}[5m]) by (namespace))[1h:5m]) * 60 * 5
        )
      for: 10m
      labels:
        severity: warning
        component: namespace-behavior
        source: audit
        category: namespace-anomaly
        runbook_category: namespace_investigation
      annotations:
        summary: "Unusual namespace activity pattern detected"
        description: "Namespace {{$labels.namespace}} activity is 5x higher than baseline. {{$value}} operations/min"
        runbook_url: "https://github.com/kube-zen/zen-watcher/blob/main/docs/SECURITY_INCIDENT_RESPONSE.md#namespace-anomalies"
        escalation_policy: "high-2h"
        action_required: "Review activity pattern for namespace {{$labels.namespace}} - potential security issue"

  # Security Compliance Monitoring
  - name: zen-watcher.security-compliance
    interval: 5m
    rules:
    # Compliance Score Degradation
    - alert: ComplianceScoreDegradation
      expr: |
        (
          sum(rate(zen_watcher_events_total{source="kube-bench",severity=~"low|info"}[1h])) /
          (sum(rate(zen_watcher_events_total{source="kube-bench"}[1h])) + 0.001)
        ) < 0.8
      for: 30m
      labels:
        severity: warning
        component: compliance
        source: kube-bench
        category: compliance-score
        runbook_category: compliance_incident
      annotations:
        summary: "Compliance score below threshold"
        description: "Compliance score is {{$value | humanizePercentage}} - below 80% threshold"
        runbook_url: "https://github.com/kube-zen/zen-watcher/blob/main/docs/SECURITY_INCIDENT_RESPONSE.md#compliance-scores"
        escalation_policy: "high-24h"
        action_required: "Review and address compliance failures to restore score above 80%"
        
    # IaC Security Drift
    - alert: IaCSecurityDrift
      expr: |
        (
          sum(rate(zen_watcher_events_total{source="checkov",severity=~"critical|high"}[6h])) /
          (sum(rate(zen_watcher_events_total{source="checkov"}[6h])) + 0.001)
        ) > 0.3
      for: 2h
      labels:
        severity: info
        component: infrastructure-security
        source: checkov
        category: iac-drift
        runbook_category: iac_response
      annotations:
        summary: "Infrastructure as Code security drift detected"
        description: "{{$value | humanizePercentage}} of IaC scans show high/critical issues - possible configuration drift"
        runbook_url: "https://github.com/kube-zen/zen-watcher/blob/main/docs/SECURITY_INCIDENT_RESPONSE.md#iac-drift"
        escalation_policy: "medium-1w"
        action_required: "Review IaC configurations for security drift and misalignment"

  # Security Event Correlation and Intelligence
  - name: zen-watcher.security-intelligence
    interval: 5m
    rules:
    # Multiple Source Security Event Correlation
    - alert: MultiSourceSecurityEvent
      expr: |
        (
          sum(rate(zen_watcher_events_total{severity=~"critical|high"}[5m])) by (namespace) * 60
        ) > 5 and on(namespace)
        (
          count(sum(rate(zen_watcher_events_total{severity=~"critical|high"}[5m])) by (namespace, source)) by (namespace) >= 2
        )
      for: 10m
      labels:
        severity: critical
        component: event-correlation
        source: zen-watcher
        category: correlated-threat
        runbook_category: threat_investigation
      annotations:
        summary: "Correlated security events across multiple sources"
        description: "Namespace {{$labels.namespace}} has security events from multiple sources"
        runbook_url: "https://github.com/kube-zen/zen-watcher/blob/main/docs/SECURITY_INCIDENT_RESPONSE.md#correlated-events"
        escalation_policy: "critical-30m"
        action_required: "Investigate correlated security events in namespace {{$labels.namespace}} - possible coordinated attack"
        
    # Vulnerability and Runtime Threat Correlation
    - alert: VulnerabilityRuntimeCorrelation
      expr: |
        (
          sum(rate(zen_watcher_events_total{source="falco",severity=~"critical|high"}[5m])) by (namespace) * 60
        ) > 0 and on(namespace)
        (
          sum(rate(zen_watcher_events_total{source="trivy",severity=~"critical|high"}[1h])) by (namespace) > 0
        )
      for: 15m
      labels:
        severity: critical
        component: threat-correlation
        source: zen-watcher
        category: vuln-runtime-correlation
        runbook_category: threat_investigation
      annotations:
        summary: "Runtime threat detected on vulnerable workload"
        description: "Runtime threats detected in namespace {{$labels.namespace}} that also has known vulnerabilities"
        runbook_url: "https://github.com/kube-zen/zen-watcher/blob/main/docs/SECURITY_INCIDENT_RESPONSE.md#vuln-runtime-correlation"
        escalation_policy: "critical-immediate"
        action_required: "Immediate investigation required - vulnerable namespace showing runtime threats"

  # Security Tool Health and Performance
  - name: zen-watcher.security-tool-health
    interval: 2m
    rules:
    # Falco Performance Issues
    - alert: FalcoPerformanceIssues
      expr: |
        histogram_quantile(0.95, 
          sum(rate(zen_watcher_event_processing_duration_seconds_bucket{source="falco"}[5m])) by (le)
        ) > 10
      for: 10m
      labels:
        severity: warning
        component: performance
        source: zen-watcher
        category: tool-performance
        runbook_category: performance_incident
      annotations:
        summary: "Falco event processing latency high"
        description: "95th percentile processing latency for Falco events is {{$value}}s"
        runbook_url: "https://github.com/kube-zen/zen-watcher/blob/main/docs/SECURITY_INCIDENT_RESPONSE.md#falco-performance"
        escalation_policy: "medium-4h"
        action_required: "Investigate Falco processing performance issues"
        
    # High False Positive Rate
    - alert: HighFalsePositiveRate
      expr: |
        (
          sum(rate(zen_watcher_events_total{eventType=~".*suspicious.*|.*unauthorized.*"}[5m])) /
          (sum(rate(zen_watcher_events_total[5m])) + 0.001)
        ) > 0.4
      for: 30m
      labels:
        severity: info
        component: accuracy
        source: zen-watcher
        category: false-positive
        runbook_category: tuning
      annotations:
        summary: "High false positive rate detected"
        description: "{{$value | humanizePercentage}} of events are suspicious/unauthorized alerts - possible rule tuning needed"
        runbook_url: "https://github.com/kube-zen/zen-watcher/blob/main/docs/SECURITY_INCIDENT_RESPONSE.md#false-positives"
        escalation_policy: "medium-1w"
        action_required: "Review and tune security rules to reduce false positive rate"

  # Information and Trend Alerts
  - name: zen-watcher.security-trends
    interval: 10m
    rules:
    # New Security Tool Discovered
    - alert: NewSecurityToolDiscovered
      expr: changes(sum(zen_watcher_tools_active) by (tool)[10m]) > 0 and sum(zen_watcher_tools_active) by (tool) > 0
      for: 1m
      labels:
        severity: info
        component: discovery
        source: zen-watcher
        category: tool-discovery
        runbook_category: monitoring
      annotations:
        summary: "New security tool discovered"
        description: "Tool {{$labels.tool}} is now active and being monitored"
        runbook_url: "https://github.com/kube-zen/zen-watcher/blob/main/docs/SECURITY_INCIDENT_RESPONSE.md#tool-discovery"
        escalation_policy: "info"
        action_required: "Review new security tool integration and configuration"
        
    # Security Event Rate Trend
    - alert: SecurityEventTrendIncrease
      expr: |
        (
          sum(rate(zen_watcher_events_total[1h])) /
          (avg_over_time(sum(rate(zen_watcher_events_total[1h]))[7d:1h]) + 0.001)
        ) > 2
      for: 1h
      labels:
        severity: info
        component: trend-analysis
        source: zen-watcher
        category: event-trend
        runbook_category: monitoring
      annotations:
        summary: "Security event rate significantly increased"
        description: "Current security event rate is 2x higher than 7-day average"
        runbook_url: "https://github.com/kube-zen/zen-watcher/blob/main/docs/SECURITY_INCIDENT_RESPONSE.md#event-trends"
        escalation_policy: "medium-4h"
        action_required: "Review security event trend increase - investigate root cause"
        
    # Weekly Security Summary
    - alert: WeeklySecuritySummary
      expr: |
        sum(increase(zen_watcher_events_total[7d])) by (severity) > 1000
      for: 0s
      labels:
        severity: info
        component: reporting
        source: zen-watcher
        category: weekly-summary
        runbook_category: reporting
      annotations:
        summary: "Weekly security event summary"
        description: "Week summary: {{$value}} {{$labels.severity}} security events processed"
        runbook_url: "https://github.com/kube-zen/zen-watcher/blob/main/docs/SECURITY_INCIDENT_RESPONSE.md#weekly-summary"
        escalation_policy: "info"
        action_required: "Review weekly security event summary for trends and patterns"
