apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: zen-watcher-alerts
  namespace: zen-system
  labels:
    app: zen-watcher
    prometheus: kube-prometheus
    role: alert-rules
spec:
  groups:
  - name: zen-watcher-health
    interval: 30s
    rules:
    - alert: ZenWatcherDown
      expr: zen_watcher_health_status == 0
      for: 2m
      labels:
        severity: critical
        component: zen-watcher
      annotations:
        summary: "Zen Watcher is unhealthy"
        description: "Zen Watcher health check has failed for more than 2 minutes. Cluster: {{ $labels.cluster_id }}"
        runbook_url: "https://github.com/your-org/zen-watcher/wiki/Runbook-ZenWatcherDown"
    
    - alert: ZenWatcherNotReady
      expr: zen_watcher_readiness_status == 0
      for: 5m
      labels:
        severity: warning
        component: zen-watcher
      annotations:
        summary: "Zen Watcher is not ready"
        description: "Zen Watcher readiness probe has been failing for 5 minutes. Cluster: {{ $labels.cluster_id }}"
    
    - alert: ZenWatcherHighMemoryUsage
      expr: process_resident_memory_bytes{job="zen-watcher"} / 1024 / 1024 > 512
      for: 10m
      labels:
        severity: warning
        component: zen-watcher
      annotations:
        summary: "Zen Watcher high memory usage"
        description: "Zen Watcher is using {{ $value }}MB of memory (threshold: 512MB). Cluster: {{ $labels.cluster_id }}"
    
    - alert: ZenWatcherHighCPUUsage
      expr: rate(process_cpu_seconds_total{job="zen-watcher"}[5m]) > 0.9
      for: 10m
      labels:
        severity: warning
        component: zen-watcher
      annotations:
        summary: "Zen Watcher high CPU usage"
        description: "Zen Watcher CPU usage is at {{ $value | humanizePercentage }}. Cluster: {{ $labels.cluster_id }}"
    
    - alert: ZenWatcherTooManyGoroutines
      expr: zen_watcher_goroutines > 1000
      for: 5m
      labels:
        severity: warning
        component: zen-watcher
      annotations:
        summary: "Zen Watcher has too many goroutines"
        description: "Zen Watcher has {{ $value }} goroutines, possible goroutine leak. Cluster: {{ $labels.cluster_id }}"

  - name: zen-watcher-events
    interval: 30s
    rules:
    - alert: HighCriticalEventRate
      expr: rate(zen_watcher_events_total{severity="CRITICAL"}[5m]) > 10
      for: 5m
      labels:
        severity: critical
        component: zen-watcher
        category: events
      annotations:
        summary: "High rate of critical security events"
        description: "Detecting {{ $value }} critical events per second. Source: {{ $labels.source }}. Cluster: {{ $labels.cluster_id }}"
        runbook_url: "https://github.com/your-org/zen-watcher/wiki/Runbook-HighCriticalEventRate"
    
    - alert: TooManyCriticalEvents
      expr: sum(zen_watcher_active_events{severity="CRITICAL"}) > 100
      for: 10m
      labels:
        severity: critical
        component: zen-watcher
        category: events
      annotations:
        summary: "Too many unresolved critical events"
        description: "There are {{ $value }} active critical events. Immediate attention required. Cluster: {{ $labels.cluster_id }}"
    
    - alert: TooManyHighSeverityEvents
      expr: sum(zen_watcher_active_events{severity="HIGH"}) > 500
      for: 15m
      labels:
        severity: warning
        component: zen-watcher
        category: events
      annotations:
        summary: "Too many high severity events"
        description: "There are {{ $value }} active high severity events. Review required. Cluster: {{ $labels.cluster_id }}"
    
    - alert: EventWriteFailures
      expr: rate(zen_watcher_events_failures_total[5m]) > 1
      for: 5m
      labels:
        severity: warning
        component: zen-watcher
        category: events
      annotations:
        summary: "High rate of event write failures"
        description: "Failing to write events at {{ $value }}/sec. Source: {{ $labels.source }}, Reason: {{ $labels.reason }}. Cluster: {{ $labels.cluster_id }}"

  - name: zen-watcher-watchers
    interval: 30s
    rules:
    - alert: WatcherDisabled
      expr: zen_watcher_watcher_status == 0
      for: 5m
      labels:
        severity: info
        component: zen-watcher
        category: watchers
      annotations:
        summary: "Watcher is disabled"
        description: "Watcher {{ $labels.watcher }} is disabled. This may be intentional. Cluster: {{ $labels.cluster_id }}"
    
    - alert: WatcherErrors
      expr: rate(zen_watcher_watcher_errors_total[5m]) > 0.1
      for: 5m
      labels:
        severity: warning
        component: zen-watcher
        category: watchers
      annotations:
        summary: "Watcher experiencing errors"
        description: "Watcher {{ $labels.watcher }} is experiencing {{ $value }} errors/sec. Error type: {{ $labels.error_type }}. Cluster: {{ $labels.cluster_id }}"
    
    - alert: SlowWatcherScrape
      expr: histogram_quantile(0.95, sum(rate(zen_watcher_scrape_duration_seconds_bucket[5m])) by (le, watcher)) > 30
      for: 10m
      labels:
        severity: warning
        component: zen-watcher
        category: performance
      annotations:
        summary: "Watcher scrape is slow"
        description: "Watcher {{ $labels.watcher }} p95 scrape duration is {{ $value }}s (threshold: 30s). Cluster: {{ $labels.cluster_id }}"

  - name: zen-watcher-operations
    interval: 30s
    rules:
    - alert: HighCRDOperationFailureRate
      expr: rate(zen_watcher_crd_operations_total{status="failure"}[5m]) / rate(zen_watcher_crd_operations_total[5m]) > 0.05
      for: 5m
      labels:
        severity: critical
        component: zen-watcher
        category: operations
      annotations:
        summary: "High CRD operation failure rate"
        description: "{{ $value | humanizePercentage }} of CRD operations are failing. Operation: {{ $labels.operation }}. Cluster: {{ $labels.cluster_id }}"
        runbook_url: "https://github.com/your-org/zen-watcher/wiki/Runbook-CRDOperationFailures"
    
    - alert: SlowCRDOperations
      expr: histogram_quantile(0.95, sum(rate(zen_watcher_crd_operation_duration_seconds_bucket[5m])) by (le, operation)) > 5
      for: 10m
      labels:
        severity: warning
        component: zen-watcher
        category: performance
      annotations:
        summary: "CRD operations are slow"
        description: "CRD operation {{ $labels.operation }} p95 latency is {{ $value }}s (threshold: 5s). Cluster: {{ $labels.cluster_id }}"
    
    - alert: HTTPErrorRate
      expr: rate(zen_watcher_http_requests_total{status=~"5.."}[5m]) > 0.1
      for: 5m
      labels:
        severity: warning
        component: zen-watcher
        category: operations
      annotations:
        summary: "High HTTP error rate"
        description: "HTTP endpoint {{ $labels.endpoint }} experiencing {{ $value }} errors/sec. Cluster: {{ $labels.cluster_id }}"
    
    - alert: SlowHTTPRequests
      expr: histogram_quantile(0.95, sum(rate(zen_watcher_http_request_duration_seconds_bucket[5m])) by (le, endpoint)) > 1
      for: 10m
      labels:
        severity: info
        component: zen-watcher
        category: performance
      annotations:
        summary: "Slow HTTP requests"
        description: "HTTP endpoint {{ $labels.endpoint }} p95 latency is {{ $value }}s. Cluster: {{ $labels.cluster_id }}"

  - name: zen-watcher-kubernetes
    interval: 30s
    rules:
    - alert: KubernetesAPIErrors
      expr: rate(zen_watcher_k8s_api_requests_total{status=~"error|failure"}[5m]) > 0.1
      for: 5m
      labels:
        severity: warning
        component: zen-watcher
        category: kubernetes
      annotations:
        summary: "Kubernetes API errors"
        description: "Experiencing {{ $value }} Kubernetes API errors/sec. Resource: {{ $labels.resource }}. Cluster: {{ $labels.cluster_id }}"
    
    - alert: SlowKubernetesAPIRequests
      expr: histogram_quantile(0.95, sum(rate(zen_watcher_k8s_api_request_duration_seconds_bucket[5m])) by (le, resource)) > 10
      for: 10m
      labels:
        severity: warning
        component: zen-watcher
        category: performance
      annotations:
        summary: "Slow Kubernetes API requests"
        description: "Kubernetes API requests for {{ $labels.resource }} are slow: {{ $value }}s p95 latency. Cluster: {{ $labels.cluster_id }}"

  - name: zen-watcher-slo
    interval: 1m
    rules:
    # Event Processing SLO: 99% of events should be processed within 5 seconds
    - alert: EventProcessingSLOViolation
      expr: |
        (
          histogram_quantile(0.99, sum(rate(zen_watcher_event_processing_duration_seconds_bucket[5m])) by (le))
          > 5
        )
      for: 10m
      labels:
        severity: warning
        component: zen-watcher
        category: slo
      annotations:
        summary: "Event processing SLO violation"
        description: "99th percentile event processing duration is {{ $value }}s (SLO: 5s). Cluster: {{ $labels.cluster_id }}"
    
    # Availability SLO: 99.9% uptime
    - alert: AvailabilitySLOViolation
      expr: |
        (
          sum(rate(zen_watcher_health_status[5m]))
          / 
          sum(rate(zen_watcher_health_status[5m]) + rate(zen_watcher_health_status{} == 0[5m]))
        ) < 0.999
      for: 5m
      labels:
        severity: critical
        component: zen-watcher
        category: slo
      annotations:
        summary: "Availability SLO violation"
        description: "Zen Watcher availability is {{ $value | humanizePercentage }} (SLO: 99.9%). Cluster: {{ $labels.cluster_id }}"


