apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: zen-watcher-alerts
  namespace: zen-system
  labels:
    app: zen-watcher
    prometheus: kube-prometheus
    role: alert-rules
spec:
  groups:
  - name: zen-watcher-health
    interval: 30s
    rules:
    - alert: ZenWatcherDown
      expr: zen_watcher_health_status == 0
      for: 2m
      labels:
        severity: critical
        component: zen-watcher
      annotations:
        summary: "Zen Watcher is unhealthy"
        runbook_url: "https://github.com/your-org/zen-watcher/wiki/Runbook-ZenWatcherDown"
    
    - alert: ZenWatcherNotReady
      expr: zen_watcher_readiness_status == 0
      for: 5m
      labels:
        severity: warning
        component: zen-watcher
      annotations:
        summary: "Zen Watcher is not ready"
    
    - alert: ZenWatcherHighMemoryUsage
      expr: process_resident_memory_bytes{job="zen-watcher"} / 1024 / 1024 > 512
      for: 10m
      labels:
        severity: warning
        component: zen-watcher
      annotations:
        summary: "Zen Watcher high memory usage"
    
    - alert: ZenWatcherHighCPUUsage
      expr: rate(process_cpu_seconds_total{job="zen-watcher"}[5m]) > 0.9
      for: 10m
      labels:
        severity: warning
        component: zen-watcher
      annotations:
        summary: "Zen Watcher high CPU usage"
    
    - alert: ZenWatcherTooManyGoroutines
      expr: zen_watcher_goroutines > 1000
      for: 5m
      labels:
        severity: warning
        component: zen-watcher
      annotations:
        summary: "Zen Watcher has too many goroutines"

  - name: zen-watcher-events
    interval: 30s
    rules:
    - alert: HighCriticalEventRate
      expr: rate(zen_watcher_events_total{severity="CRITICAL"}[5m]) > 10
      for: 5m
      labels:
        severity: critical
        component: zen-watcher
        category: events
      annotations:
        summary: "High rate of critical security events"
        runbook_url: "https://github.com/your-org/zen-watcher/wiki/Runbook-HighCriticalEventRate"
    
    - alert: TooManyCriticalEvents
      expr: sum(zen_watcher_active_events{severity="CRITICAL"}) > 100
      for: 10m
      labels:
        severity: critical
        component: zen-watcher
        category: events
      annotations:
        summary: "Too many unresolved critical events"
    
    - alert: TooManyHighSeverityEvents
      expr: sum(zen_watcher_active_events{severity="HIGH"}) > 500
      for: 15m
      labels:
        severity: warning
        component: zen-watcher
        category: events
      annotations:
        summary: "Too many high severity events"
    
    - alert: EventWriteFailures
      expr: rate(zen_watcher_events_failures_total[5m]) > 1
      for: 5m
      labels:
        severity: warning
        component: zen-watcher
        category: events
      annotations:
        summary: "High rate of event write failures"

  - name: zen-watcher-watchers
    interval: 30s
    rules:
    - alert: WatcherDisabled
      expr: zen_watcher_watcher_status == 0
      for: 5m
      labels:
        severity: info
        component: zen-watcher
        category: watchers
      annotations:
        summary: "Watcher is disabled"
    
    - alert: WatcherErrors
      expr: rate(zen_watcher_watcher_errors_total[5m]) > 0.1
      for: 5m
      labels:
        severity: warning
        component: zen-watcher
        category: watchers
      annotations:
        summary: "Watcher experiencing errors"
    
    - alert: SlowWatcherScrape
      expr: histogram_quantile(0.95, sum(rate(zen_watcher_scrape_duration_seconds_bucket[5m])) by (le, watcher)) > 30
      for: 10m
      labels:
        severity: warning
        component: zen-watcher
        category: performance
      annotations:
        summary: "Watcher scrape is slow"

  - name: zen-watcher-operations
    interval: 30s
    rules:
    - alert: HighCRDOperationFailureRate
      expr: rate(zen_watcher_crd_operations_total{status="failure"}[5m]) / rate(zen_watcher_crd_operations_total[5m]) > 0.05
      for: 5m
      labels:
        severity: critical
        component: zen-watcher
        category: operations
      annotations:
        summary: "High CRD operation failure rate"
        runbook_url: "https://github.com/your-org/zen-watcher/wiki/Runbook-CRDOperationFailures"
    
    - alert: SlowCRDOperations
      expr: histogram_quantile(0.95, sum(rate(zen_watcher_crd_operation_duration_seconds_bucket[5m])) by (le, operation)) > 5
      for: 10m
      labels:
        severity: warning
        component: zen-watcher
        category: performance
      annotations:
        summary: "CRD operations are slow"
    
    - alert: HTTPErrorRate
      expr: rate(zen_watcher_http_requests_total{status=~"5.."}[5m]) > 0.1
      for: 5m
      labels:
        severity: warning
        component: zen-watcher
        category: operations
      annotations:
        summary: "High HTTP error rate"
    
    - alert: SlowHTTPRequests
      expr: histogram_quantile(0.95, sum(rate(zen_watcher_http_request_duration_seconds_bucket[5m])) by (le, endpoint)) > 1
      for: 10m
      labels:
        severity: info
        component: zen-watcher
        category: performance
      annotations:
        summary: "Slow HTTP requests"

  - name: zen-watcher-kubernetes
    interval: 30s
    rules:
    - alert: KubernetesAPIErrors
      expr: rate(zen_watcher_k8s_api_requests_total{status=~"error|failure"}[5m]) > 0.1
      for: 5m
      labels:
        severity: warning
        component: zen-watcher
        category: kubernetes
      annotations:
        summary: "Kubernetes API errors"
    
    - alert: SlowKubernetesAPIRequests
      expr: histogram_quantile(0.95, sum(rate(zen_watcher_k8s_api_request_duration_seconds_bucket[5m])) by (le, resource)) > 10
      for: 10m
      labels:
        severity: warning
        component: zen-watcher
        category: performance
      annotations:
        summary: "Slow Kubernetes API requests"

  - name: zen-watcher-slo
    interval: 1m
    rules:
    # Event Processing SLO: 99% of events should be processed within 5 seconds
    - alert: EventProcessingSLOViolation
      expr: |
        (
          histogram_quantile(0.99, sum(rate(zen_watcher_event_processing_duration_seconds_bucket[5m])) by (le))
          > 5
        )
      for: 10m
      labels:
        severity: warning
        component: zen-watcher
        category: slo
      annotations:
        summary: "Event processing SLO violation"
    
    # Availability SLO: 99.9% uptime
    - alert: AvailabilitySLOViolation
      expr: |
        (
          sum(rate(zen_watcher_health_status[5m]))
          / 
          sum(rate(zen_watcher_health_status[5m]) + rate(zen_watcher_health_status{} == 0[5m]))
        ) < 0.999
      for: 5m
      labels:
        severity: critical
        component: zen-watcher
        category: slo
      annotations:
        summary: "Availability SLO violation"


