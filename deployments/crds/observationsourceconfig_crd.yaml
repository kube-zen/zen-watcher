apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: observationsourceconfigs.zen.kube-zen.io
spec:
  group: zen.kube-zen.io
  names:
    kind: ObservationSourceConfig
    listKind: ObservationSourceConfigList
    plural: observationsourceconfigs
    singular: observationsourceconfig
    shortNames:
      - obssourceconfig
      - osc
  scope: Namespaced
  versions:
    - name: v1alpha1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              required: ["source", "ingester"]
              properties:
                source:
                  type: string
                  description: "Tool name (trivy, kyverno, sealed-secrets, etc.)"
                  pattern: "^[a-z0-9-]+$"
                ingester:
                  type: string
                  description: "Ingester type: informer, webhook, logs, cm, or k8s-events"
                  enum: [informer, webhook, logs, cm, k8s-events]
                filter:
                  type: object
                  description: "Filter configuration for this source"
                  properties:
                    minPriority:
                      type: number
                      description: "Minimum priority (0.0-1.0) to allow. Observations below this are filtered out."
                      minimum: 0.0
                      maximum: 1.0
                    excludeNamespaces:
                      type: array
                      description: "List of namespaces to exclude"
                      items:
                        type: string
                    includeTypes:
                      type: array
                      description: "List of event types to include (if set, only these are allowed)"
                      items:
                        type: string
                dedup:
                  type: object
                  description: "Deduplication configuration for this source"
                  properties:
                    window:
                      type: string
                      description: "Deduplication window as duration string (e.g., '24h', '1h30m')"
                      pattern: "^[0-9]+(ns|us|µs|ms|s|m|h)$"
                    strategy:
                      type: string
                      description: "Deduplication strategy: fingerprint (content-based), key (field-based), hybrid, or adaptive"
                      enum:
                        - fingerprint
                        - key
                        - hybrid
                        - adaptive
                      default: fingerprint
                    adaptive:
                      type: boolean
                      description: "Enable adaptive deduplication that adjusts based on patterns"
                      default: false
                    fields:
                      type: array
                      description: "Fields to use for deduplication key (only used if strategy=key or hybrid)"
                      items:
                        type: string
                    minChange:
                      type: number
                      description: "Minimum change threshold (0.0-1.0) to trigger adaptation"
                      minimum: 0.0
                      maximum: 1.0
                      default: 0.05
                    learningRate:
                      type: number
                      description: "Learning rate for adaptive deduplication (0.0-1.0)"
                      minimum: 0.0
                      maximum: 1.0
                      default: 0.1
                ttl:
                  type: object
                  description: "TTL configuration for observations from this source"
                  properties:
                    default:
                      type: string
                      description: "Default TTL as duration string (e.g., '30d', '7d')"
                      pattern: "^[0-9]+(ns|us|µs|ms|s|m|h|d)$"
                    min:
                      type: string
                      description: "Minimum allowed TTL as duration string"
                      pattern: "^[0-9]+(ns|us|µs|ms|s|m|h|d)$"
                    max:
                      type: string
                      description: "Maximum allowed TTL as duration string"
                      pattern: "^[0-9]+(ns|us|µs|ms|s|m|h|d)$"
                rateLimit:
                  type: object
                  description: "Rate limiting configuration for this source"
                  properties:
                    maxPerMinute:
                      type: integer
                      description: "Maximum observations per minute from this source"
                      minimum: 1
                    burst:
                      type: integer
                      description: "Burst capacity (number of observations allowed in short burst)"
                      minimum: 1
                typeConfig:
                  type: object
                  description: "Optional override for default type detection"
                  properties:
                    typeDetection:
                      type: string
                      description: "How to detect observation type: auto, field, or static"
                      enum:
                        - auto
                        - field
                        - static
                    typeField:
                      type: string
                      description: "Field path in raw data to extract type from (if typeDetection=field)"
                    staticType:
                      type: string
                      description: "Static type to use for all observations (if typeDetection=static)"
                # INFORMER configuration (for CRD-based tools)
                informer:
                  type: object
                  description: "Informer adapter configuration"
                  properties:
                    gvr:
                      type: object
                      required: ["group", "version", "resource"]
                      properties:
                        group:
                          type: string
                        version:
                          type: string
                        resource:
                          type: string
                    namespace:
                      type: string
                      description: "Optional namespace to watch (empty = all namespaces)"
                    labelSelector:
                      type: string
                      description: "Optional label selector"
                    fieldSelector:
                      type: string
                      description: "Optional field selector"
                    resyncPeriod:
                      type: string
                      description: "Resync period (e.g., '30m')"
                      default: "0"
                # WEBHOOK configuration (for push-based tools)
                webhook:
                  type: object
                  description: "Webhook adapter configuration"
                  properties:
                    path:
                      type: string
                      description: "HTTP path for webhook endpoint"
                    port:
                      type: integer
                      description: "Port to listen on"
                      minimum: 1
                      maximum: 65535
                    bufferSize:
                      type: integer
                      description: "Event buffer size"
                      default: 100
                    auth:
                      type: object
                      description: "Authentication configuration"
                      properties:
                        type:
                          type: string
                          enum: [none, bearer, basic]
                          default: none
                        secretName:
                          type: string
                          description: "Secret name containing auth credentials"
                # LOGS configuration (for log-based monitoring)
                logs:
                  type: object
                  description: "Logs adapter configuration"
                  properties:
                    podSelector:
                      type: string
                      description: "Label selector for pods to monitor"
                    container:
                      type: string
                      description: "Container name (empty = first container)"
                      default: ""
                    patterns:
                      type: array
                      description: "Regex patterns to match in logs"
                      items:
                        type: object
                        required: ["regex", "type"]
                        properties:
                          regex:
                            type: string
                            description: "Regex pattern with named capture groups"
                          type:
                            type: string
                            description: "Event type when pattern matches"
                          priority:
                            type: number
                            description: "Priority (0.0-1.0)"
                            minimum: 0.0
                            maximum: 1.0
                    sinceSeconds:
                      type: integer
                      description: "How far back to read logs (seconds)"
                      default: 300
                    pollInterval:
                      type: string
                      description: "Poll interval for checking new pods"
                      default: "1s"
                # CONFIGMAP configuration (for batch tools)
                configmap:
                  type: object
                  description: "ConfigMap adapter configuration"
                  properties:
                    namespace:
                      type: string
                      description: "Namespace to watch (empty = all namespaces)"
                    labelSelector:
                      type: string
                      description: "Label selector for ConfigMaps"
                    pollInterval:
                      type: string
                      description: "Poll interval"
                      default: "5m"
                    jsonPath:
                      type: string
                      description: "Optional JSONPath to extract data from ConfigMap"
                # Normalization rules
                normalization:
                  type: object
                  description: "Normalization configuration"
                  properties:
                    domain:
                      type: string
                      description: "Domain: security, operations, cost, compliance, custom"
                      enum: [security, operations, cost, compliance, custom]
                    type:
                      type: string
                      description: "Event type"
                    priority:
                      type: object
                      description: "Priority mapping: source value -> 0.0-1.0"
                      additionalProperties:
                        type: number
                        minimum: 0.0
                        maximum: 1.0
                    fieldMapping:
                      type: array
                      description: "Field mappings from raw data to labels"
                      items:
                        type: object
                        properties:
                          from:
                            type: string
                            description: "JSONPath in raw data"
                          to:
                            type: string
                            description: "Label or field name"
                thresholds:
                  type: object
                  description: "Optimization thresholds for monitoring and alerts"
                  properties:
                    observationsPerMinute:
                      type: object
                      description: "Observation rate thresholds"
                      properties:
                        warning:
                          type: integer
                          description: "Warning threshold for observations per minute"
                          minimum: 1
                        critical:
                          type: integer
                          description: "Critical threshold for observations per minute"
                          minimum: 1
                    lowSeverityPercent:
                      type: object
                      description: "Low severity ratio thresholds"
                      properties:
                        warning:
                          type: number
                          description: "Warning threshold for low severity percentage (0.0-1.0)"
                          minimum: 0.0
                          maximum: 1.0
                        critical:
                          type: number
                          description: "Critical threshold for low severity percentage (0.0-1.0)"
                          minimum: 0.0
                          maximum: 1.0
                    dedupEffectiveness:
                      type: object
                      description: "Deduplication effectiveness thresholds"
                      properties:
                        warning:
                          type: number
                          description: "Warning threshold for dedup effectiveness (0.0-1.0, lower = worse)"
                          minimum: 0.0
                          maximum: 1.0
                        critical:
                          type: number
                          description: "Critical threshold for dedup effectiveness (0.0-1.0, lower = worse)"
                          minimum: 0.0
                          maximum: 1.0
                    custom:
                      type: array
                      description: "Custom thresholds against raw data"
                      items:
                        type: object
                        properties:
                          name:
                            type: string
                          field:
                            type: string
                            description: "JSONPath in raw data"
                          operator:
                            type: string
                            enum: [">", "<", "==", "!=", "contains"]
                          value:
                            type: string
                            description: "Value to compare against"
                          message:
                            type: string
                processing:
                  type: object
                  description: "Processing order configuration"
                  properties:
                    order:
                      type: string
                      description: "Processing order: auto (learn and optimize), filter_first, dedup_first, hybrid, or adaptive"
                      enum:
                        - auto
                        - filter_first
                        - dedup_first
                        - hybrid
                        - adaptive
                      default: auto
                    autoOptimize:
                      type: boolean
                      description: "Allow Zen Watcher to automatically optimize processing order based on metrics"
                      default: true
                    analysisInterval:
                      type: string
                      description: "How often to analyze performance and adjust optimization (e.g., '15m', '30m')"
                      pattern: "^[0-9]+(ns|us|µs|ms|s|m|h)$"
                      default: "15m"
                    confidenceThreshold:
                      type: number
                      description: "Minimum confidence (0.0-1.0) required for auto-optimization decisions"
                      minimum: 0.0
                      maximum: 1.0
                      default: 0.7
                    thresholds:
                      type: object
                      description: "Per-metric thresholds for optimization triggers"
                      additionalProperties:
                        type: object
                        properties:
                          warning:
                            type: number
                            description: "Warning threshold value"
                          critical:
                            type: number
                            description: "Critical threshold value"
                          action:
                            type: string
                            description: "Action to take when threshold is exceeded: warn, alert, optimize"
                            enum: [warn, alert, optimize]
                          description:
                            type: string
                            description: "Human-readable description of this threshold"
      subresources:
        status: {}
      additionalPrinterColumns:
        - name: Source
          type: string
          jsonPath: .spec.source
        - name: Dedup Window
          type: string
          jsonPath: .spec.dedup.window
          priority: 1
        - name: Min Priority
          type: number
          format: double
          jsonPath: .spec.filter.minPriority
          priority: 1
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp

